name: Go Code Quality ğŸ§ª

# Trigger the workflow on push or pull request events for all branches
on:
  push:
    branches: [ "**" ] # Matches all branches ğŸŒ
  pull_request:
    branches: [ "**" ] # Matches all branches ğŸŒ

jobs:
  code-quality:
    runs-on: ubuntu-latest

    steps:
    # Step 1: Checkout the repository ğŸ“‚
    - name: ğŸ“‚ Checkout code
      uses: actions/checkout@v4

    # Step 2: Set up Go environment ğŸ› ï¸
    - name: ğŸ› ï¸ Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24' # Replace with your Go version ğŸ˜
        cache: true # Enable caching for faster builds ğŸš€

    # Step 3: Install formatting tools âœ‚ï¸
    - name: âœ‚ï¸ Install formatting tools
      run: go install golang.org/x/tools/cmd/goimports@latest

    # Step 4: Check formatting with gofmt ğŸ“ (fail if not formatted correctly)
    - name: ğŸ“ Check formatting with gofmt
      run: |
        diff=$(gofmt -s -d .)
        if [ -n "$diff" ]; then
          echo "âŒ Uh-oh! Code is not formatted with gofmt. Hereâ€™s the diff:"
          echo "$diff"
          echo "ğŸ’¡ Please run 'gofmt -s -w .' locally to format your code and try again! ğŸ˜Š"
          exit 1
        else
          echo "âœ… Looking good! Code is formatted with gofmt. ğŸ‰"
        fi

    # Step 5: Check import organization with goimports ğŸ“š (fail if not organized correctly)
    - name: ğŸ“š Check imports with goimports
      run: |
        diff=$(goimports -d .)
        if [ -n "$diff" ]; then
          echo "âŒ Oops! Imports are not organized with goimports. Hereâ€™s the diff:"
          echo "$diff"
          echo "ğŸ’¡ Please run 'goimports -w .' locally to organize imports and try again! ğŸ˜Š"
          exit 1
        else
          echo "âœ… Nice work! Imports are organized with goimports. ğŸ‰"
        fi

    # Step 6: Run go vet for basic static analysis ğŸ” (fail if issues are found)
    - name: ğŸ” Run go vet
      run: |
        echo "ğŸ” Checking for issues with go vet..."
        go vet ./...
        echo "âœ… No issues found with go vet! ğŸ‰"

    # Step 7: Install and run staticcheck for advanced linting ğŸ•µï¸ (fail if issues are found)
    - name: ğŸ•µï¸ Install staticcheck
      run: go install honnef.co/go/tools/cmd/staticcheck@latest

    - name: ğŸ•µï¸ Run staticcheck
      run: |
        echo "ğŸ•µï¸ Running staticcheck for advanced linting..."
        staticcheck ./...
        echo "âœ… No issues found with staticcheck! ğŸ‰"

    # Step 8: Run tests with coverage ğŸ§ª (fail if tests fail)
    - name: ğŸ§ª Run tests
      run: |
        echo "ğŸ§ª Running tests with coverage..."
        go test -v -coverprofile=cover.out ./...
        echo "âœ… All tests passed! Great job! ğŸ‰"

    # Step 9: Upload coverage report ğŸ“Š (optional, won't fail if upload fails)
    - name: ğŸ“Š Upload coverage report
      if: success() # Only run if previous steps succeeded âœ…
      uses: codecov/codecov-action@v4
      with:
        files: ./cover.out
        fail_ci_if_error: false # Won't fail the pipeline if upload fails ğŸ™ˆ
